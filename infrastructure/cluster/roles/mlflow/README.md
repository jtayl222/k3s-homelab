# MLflow Role

This Ansible role deploys MLflow tracking server on Kubernetes with S3-compatible storage backend (MinIO) and sealed secrets for secure credential management.

## Overview

MLflow is an open-source platform for managing the ML lifecycle, including experimentation, reproducibility, deployment, and a central model registry. This role deploys MLflow as a containerized service in your Kubernetes cluster.

## Architecture

```
üèóÔ∏è MLflow Deployment Architecture
‚îú‚îÄ‚îÄ üì¶ MLflow Server (Deployment)
‚îÇ   ‚îú‚îÄ‚îÄ Experiment Tracking API
‚îÇ   ‚îú‚îÄ‚îÄ Model Registry
‚îÇ   ‚îî‚îÄ‚îÄ Artifact Store (S3/MinIO)
‚îú‚îÄ‚îÄ üóÑÔ∏è Storage Layer
‚îÇ   ‚îú‚îÄ‚îÄ SQLite Database (PVC)
‚îÇ   ‚îî‚îÄ‚îÄ S3 Artifacts (MinIO)
‚îú‚îÄ‚îÄ üîê Security
‚îÇ   ‚îú‚îÄ‚îÄ Sealed Secrets (S3 credentials)
‚îÇ   ‚îî‚îÄ‚îÄ Namespace isolation
‚îî‚îÄ‚îÄ üåê Service (NodePort)
    ‚îî‚îÄ‚îÄ External access on port 30800
```

## Features

- ‚úÖ **Experiment Tracking** - Log parameters, metrics, and artifacts
- ‚úÖ **Model Registry** - Version and manage ML models
- ‚úÖ **S3 Backend** - Secure artifact storage via MinIO
- ‚úÖ **Sealed Secrets** - GitOps-ready credential management
- ‚úÖ **Persistent Storage** - SQLite database on PVC
- ‚úÖ **External Access** - NodePort service for web UI
- ‚úÖ **Production Ready** - Resource limits and health checks

## Requirements

### Dependencies
- Kubernetes cluster with CSI storage
- Sealed Secrets controller deployed
- MinIO deployed and accessible
- Ansible collections:
  - `kubernetes.core`

### Variables
| Variable | Default | Description |
|----------|---------|-------------|
| `mlflow_namespace` | `mlflow` | Kubernetes namespace |
| `mlflow_memory_request` | `512Mi` | Memory request |
| `mlflow_memory_limit` | `1Gi` | Memory limit |
| `mlflow_cpu_request` | `100m` | CPU request |
| `mlflow_cpu_limit` | `500m` | CPU limit |
| `kubeconfig_path` | - | Path to kubeconfig file |

## Deployment

### 1. Prerequisites
Ensure sealed secrets are created:
```bash
./scripts/create-all-sealed-secret.sh
```

### 2. Deploy MLflow
```bash
# Deploy complete MLflow stack
ansible-playbook -i inventory/production/hosts infrastructure/cluster/site.yml --tags="mlflow"

# Deploy only specific components
ansible-playbook site.yml --tags="mlflow,deployment"  # Just the deployment
ansible-playbook site.yml --tags="mlflow,storage"     # Just storage components
ansible-playbook site.yml --tags="mlflow,service"     # Just the service
```

### 3. Verify Deployment
```bash
# Check deployment status
kubectl get all -n mlflow

# Check logs
kubectl logs -n mlflow deployment/mlflow

# Test connectivity
curl http://192.168.1.85:30800/health
```

## Usage

### Web Interface
- **URL**: `http://192.168.1.85:30800`
- **Features**: View experiments, runs, models, artifacts
- **Authentication**: None (open access)

### Python API

#### External Access (from outside cluster)
```python
import mlflow

# Set tracking URI
mlflow.set_tracking_uri("http://192.168.1.85:30800")

# Verify connection
print(f"MLflow Tracking URI: {mlflow.get_tracking_uri()}")
```

#### Internal Access (from within cluster)
```python
import mlflow

# Use internal service DNS
mlflow.set_tracking_uri("http://mlflow.mlflow.svc.cluster.local:5000")
```

#### Complete Example
```python
import mlflow
import mlflow.sklearn
from sklearn.ensemble import RandomForestClassifier
from sklearn.datasets import load_iris
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score

# Set tracking URI
mlflow.set_tracking_uri("http://192.168.1.85:30800")

# Create experiment
mlflow.set_experiment("iris-classification")

# Start MLflow run
with mlflow.start_run():
    # Load data
    iris = load_iris()
    X_train, X_test, y_train, y_test = train_test_split(
        iris.data, iris.target, test_size=0.2, random_state=42
    )
    
    # Train model
    rf = RandomForestClassifier(n_estimators=100, random_state=42)
    rf.fit(X_train, y_train)
    
    # Make predictions
    y_pred = rf.predict(X_test)
    accuracy = accuracy_score(y_test, y_pred)
    
    # Log parameters
    mlflow.log_param("n_estimators", 100)
    mlflow.log_param("random_state", 42)
    
    # Log metrics
    mlflow.log_metric("accuracy", accuracy)
    
    # Log model
    mlflow.sklearn.log_model(rf, "model")
    
    print(f"Accuracy: {accuracy}")
    print(f"Run ID: {mlflow.active_run().info.run_id}")
```

## Configuration

### Sealed Secrets
MLflow uses sealed secrets for S3 credentials:

```yaml
# Generated by scripts/create-all-sealed-secret.sh
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: mlflow-s3-secret
  namespace: mlflow
spec:
  encryptedData:
    AWS_ACCESS_KEY_ID: AgBy3i4OJSWK+PiTySYZZA9rO5QtQFe...
    AWS_SECRET_ACCESS_KEY: AgAKAoiRBcKSadhajwGzA9rQ5QtQeL...
    MLFLOW_S3_ENDPOINT_URL: AgCT7gVdP3xJ2YHxB4tN8vCf2Q...
```

### Environment Variables
The deployment uses these environment variables:
- `MLFLOW_S3_ENDPOINT_URL`: MinIO endpoint URL
- `AWS_ACCESS_KEY_ID`: S3 access key
- `AWS_SECRET_ACCESS_KEY`: S3 secret key

### Storage
- **Database**: SQLite on persistent volume (`/mlflow/mlflow.db`)
- **Artifacts**: S3-compatible storage (MinIO bucket: `mlflow-artifacts`)

## File Structure

```
infrastructure/cluster/roles/mlflow/
‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îî‚îÄ‚îÄ main.yml                 # Main deployment tasks
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ deployment.yaml.j2       # MLflow deployment template
‚îÇ   ‚îú‚îÄ‚îÄ service.yaml.j2          # NodePort service template
‚îÇ   ‚îî‚îÄ‚îÄ pvc.yaml.j2              # Persistent volume claim
‚îî‚îÄ‚îÄ README.md                    # This file
```

## Troubleshooting

### Common Issues

#### 1. Pod CrashLoopBackOff
```bash
# Check logs
kubectl logs -n mlflow deployment/mlflow

# Common causes:
# - Missing sealed secret
# - S3 connectivity issues
# - Invalid environment variables
```

#### 2. S3 Connection Errors
```bash
# Verify MinIO is accessible
kubectl get svc -n minio

# Check S3 credentials in sealed secret
kubectl get secret -n mlflow mlflow-s3-secret -o yaml
```

#### 3. DNS Resolution Issues
```bash
# Test DNS from MLflow pod
kubectl exec -n mlflow deployment/mlflow -- nslookup minio.minio.svc.cluster.local

# Check CoreDNS
kubectl get pods -n kube-system | grep coredns
```

### Health Checks
```bash
# Check all MLflow resources
kubectl get all -n mlflow

# Test API endpoint
curl http://192.168.1.85:30800/api/2.0/mlflow/experiments/search

# Check storage
kubectl exec -n mlflow deployment/mlflow -- ls -la /mlflow/
```

## Integration

### JupyterHub Integration
MLflow is pre-configured to work with JupyterHub:
```python
# From JupyterHub notebooks, use internal DNS
mlflow.set_tracking_uri("http://mlflow.mlflow.svc.cluster.local:5000")
```

### Argo Workflows Integration
Reference MLflow in workflow templates:
```yaml
# In Argo Workflow templates
env:
- name: MLFLOW_TRACKING_URI
  value: "http://mlflow.mlflow.svc.cluster.local:5000"
```

## Security Considerations

- ‚úÖ **Sealed Secrets**: S3 credentials encrypted at rest
- ‚úÖ **Namespace Isolation**: Deployed in dedicated namespace
- ‚úÖ **Resource Limits**: CPU and memory constraints
- ‚ö†Ô∏è **Open Access**: No authentication (suitable for homelab)
- ‚ö†Ô∏è **HTTP Only**: No TLS encryption (internal network)

## Monitoring

MLflow integrates with the platform monitoring stack:
- **Prometheus**: Metrics collection from MLflow pods
- **Grafana**: Dashboards for MLflow performance
- **Logs**: Centralized logging via cluster logging

## Backup and Recovery

### Database Backup
```bash
# Backup SQLite database
kubectl exec -n mlflow deployment/mlflow -- cp /mlflow/mlflow.db /tmp/backup.db
kubectl cp mlflow/mlflow-pod:/tmp/backup.db ./mlflow-backup.db
```

### Artifact Backup
Artifacts are stored in MinIO - refer to MinIO backup procedures.

## Updates and Maintenance

### Update MLflow Version
1. Update image version in `templates/deployment.yaml.j2`
2. Test in development environment
3. Deploy with rolling update:
```bash
ansible-playbook site.yml --tags="mlflow,deployment"
```

### Scale MLflow
```bash
# Scale replicas (not recommended for SQLite backend)
kubectl scale deployment mlflow -n mlflow --replicas=2
```

## Contributing

When modifying this role:
1. Update templates in `templates/` directory
2. Test changes with `--check` and `--diff` flags
3. Update this README with any new features
4. Tag deployments appropriately

## Links

- [MLflow Documentation](https://mlflow.org/docs/latest/)
- [MLflow Python API](https://mlflow.org/docs/latest/python_api/)
- [MLflow REST API](https://mlflow.org/docs/latest/rest-api.html)
- [MinIO Integration](https://docs.min.io/docs/how-to-use-aws-sdk-for-python-with-minio-server.html)

---

**Part of the K3s Homelab MLOps Platform** | [Main Documentation](../../README.md)