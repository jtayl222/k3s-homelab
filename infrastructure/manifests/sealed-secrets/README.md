# Sealed Secrets

This directory contains SealedSecret manifests generated by the `create-all-sealed-secrets.sh` script.

## ⚠️ Security Notice

**Files in this directory are ignored by git** because they may contain sensitive data even though they're encrypted. The `.gitignore` file ensures these manifests are never committed to version control.

## Generated Files

The following files are created by the automation scripts:

- `grafana-admin-secret.yaml` - Grafana admin credentials for monitoring dashboard
- `minio-credentials-secret.yaml` - MinIO S3-compatible storage access credentials  
- `minio-credentials-wf.yaml` - MinIO credentials for Argo Workflows
- `minio-secret-cd.yaml` - MinIO credentials for Argo CD deployments
- `mlflow-s3-secret.yaml` - MLflow S3 backend configuration credentials
- `prometheus-admin-secret.yaml` - Prometheus admin credentials
- Additional secrets as needed by the MLOps platform

## Automation Integration

These sealed secrets are automatically created and applied by the `sealed_secrets` Ansible role:

```bash
# Generated by this script (called from Ansible)
./scripts/create-all-sealed-secrets.sh

# Applied by the sealed_secrets role
ansible-playbook site.yml --tags="sealed-secrets"
```

## Manual Creation

If you need to manually create sealed secrets:

```bash
# Example: Create a sealed secret for MinIO
kubectl create secret generic minio-credentials \
  --from-literal=accesskey=minioadmin \
  --from-literal=secretkey=minioadmin123 \
  --namespace=minio \
  --dry-run=client -o yaml | \
  kubeseal --format=yaml > minio-credentials-secret.yaml

# Example: Create a sealed secret for Grafana admin
kubectl create secret generic grafana-admin \
  --from-literal=admin-user=admin \
  --from-literal=admin-password=your-secure-password \
  --namespace=monitoring \
  --dry-run=client -o yaml | \
  kubeseal --format=yaml > grafana-admin-secret.yaml
```

## Prerequisites

Before creating sealed secrets, ensure:

- ✅ Sealed Secrets controller is running in the cluster
- ✅ `kubeseal` CLI tool is installed and configured
- ✅ `kubectl` has access to the cluster
- ✅ Target namespaces exist (minio, monitoring, argowf, argocd, mlflow)

```bash
# Verify sealed-secrets controller is ready
kubectl get pods -n kube-system | grep sealed-secrets

# Check if kubeseal can connect
kubeseal --version
```

## Applying Secrets

```bash
# Apply all sealed secrets
kubectl apply -f infrastructure/manifests/sealed-secrets/

# Apply specific secret
kubectl apply -f infrastructure/manifests/sealed-secrets/grafana-admin-secret.yaml

# Verify sealed secret was created
kubectl get sealedsecrets -A

# Check that regular secrets were generated
kubectl get secrets -n minio | grep minio-credentials
kubectl get secrets -n monitoring | grep grafana-admin
```

## Troubleshooting

### Common Issues

**SealedSecret not creating Secret:**
```bash
# Check sealed-secrets controller logs
kubectl logs -n kube-system deployment/sealed-secrets

# Verify SealedSecret syntax
kubectl describe sealedsecret <name> -n <namespace>
```

**Script fails to create secrets:**
```bash
# Check if controller is ready
kubectl get deployment sealed-secrets -n kube-system

# Verify kubeseal can fetch public key
kubeseal --fetch-cert

# Check namespace exists
kubectl get namespace minio monitoring argowf argocd mlflow
```

**Secrets not found by applications:**
```bash
# Verify secret exists in correct namespace
kubectl get secret minio-credentials -n minio

# Check secret contents (base64 encoded)
kubectl get secret minio-credentials -n minio -o yaml
```

## Security Best Practices

- ✅ **Never commit** the generated `.yaml` files to git
- ✅ **Rotate secrets** regularly by regenerating the manifests
- ✅ **Use strong passwords** when creating the initial secrets
- ✅ **Limit access** to the sealed-secrets controller namespace
- ✅ **Monitor** sealed-secrets controller logs for any issues

## Related Documentation

- [Sealed Secrets Official Docs](https://sealed-secrets.netlify.app/)
- [Bitnami Sealed Secrets Helm Chart](https://github.com/bitnami-labs/sealed-secrets)
- [K3s Homelab MLOps Platform Documentation](../../README.md)